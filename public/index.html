<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AI Math Solver</title>
    <style>
        /* Base styles */
        body {
            background-color: aquamarine;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
            -webkit-overflow-scrolling: touch;
        }

        /* Typography */
        .page-title {
            color: #1976D2;
            font-weight: bold;
            margin-bottom: 10px;
            -webkit-text-stroke: 1px #004f9e;
            -webkit-text-fill-color: #2196F3;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .footer-text {
            text-align: center;
            font-size: 1.25em;
            color: #333;
            -webkit-text-stroke: 1px #004f9e;
            -webkit-text-fill-color: #2196F3;
            font-weight: bold;
            margin-top: 20px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.15);
        }

        /* Layout containers */
        .app-container {
            position: relative;
            display: flex;
            max-width: 1200px;
            height: 100%;
            gap: 20px;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            justify-content: center;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Conversation list styles */
        .conversation-list {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: white;
            border-right: 1px solid #ccc;
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 10px;
            height: 100vh !important;
            display: flex;
            flex-direction: column;
            z-index: 9998;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.15);
        }

        .conversation-item {
            padding: 10px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.5 ease !important;
        }

        .conversation-item:hover {
            background: #d7d7d7;
        }

        .conversation-item .delete-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            display: none;
        }

        .conversation-item:hover .delete-btn {
            display: block;
        }

        .conversation-toggle {
            display: none;
            position: fixed;
            left: 10px !important;
            top: 10px !important;
            z-index: 1001;
            padding: 8px;
            height: 38.5px;
            width: 38.5px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 9999;
            transition: all 0.5s ease !important;
        }

        .conversation-toggle:hover {
            background: #1976D2;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        /* Chat container styles */
        .chat-container {
            flex: 1;
            max-width: 100% !important;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            margin-left: calc(250px + 2%) !important;
            /* Reduced side margin */
            margin-right: 2% !important;
            /* Reduced side margin */
            border-radius: 0 !important;
            overflow: hidden;
            padding: 0 !important;
            /* Remove padding */
        }

        /* Chat messages area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            /* Adjusted horizontal padding */
            margin: 0;
            /* Removed margins */
            background: white;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            scroll-behavior: smooth;
            padding-bottom: calc(70px + env(safe-area-inset-bottom)) !important;
            /* Adjusted bottom padding */
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin: 4px 0 !important;
            max-width: 95% !important;
            /* Prevent messages from being cut off */
            width: auto !important;
            padding: 10px;
            border-radius: 15px !important;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        .user-message {
            background: #e3f2fd;
            margin-left: 20px;
        }

        .ai-message {
            background: #f5f5f5;
            margin-right: 20px;
            position: relative;
            min-height: 20px;
        }

        /* Input container styles */
        .input-container {
            position: absolute !important;
            /* Changed from fixed */
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: auto !important;
            /* Changed from 100% */
            background: #ffffff !important;
            padding: 8px 12px !important;
            /* Reduced padding */
            z-index: 100 !important;
            /* Reduced z-index */
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            height: auto !important;
            min-height: 60px !important;
        }

        /* Form elements */
        input[type="text"] {
            flex: 1 1 auto !important;
            min-width: 0 !important;
            padding: 8px;
            border-radius: 12px !important;
            height: 44px !important;
            font-size: 16px !important;
            border: 1px solid #ccc;
            outline: none;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            touch-action: manipulation;
        }

        button {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 12px !important;
            cursor: pointer;
            flex: 0 0 auto !important;
            white-space: nowrap !important;
            min-width: max-content !important;
        }

        /* Image upload styles */
        .image-upload {
            position: relative;
            cursor: pointer;
            flex: 0 0 auto !important;
            margin-left: 4px !important;
        }

        .image-upload input[type="file"] {
            display: none;
        }

        .image-upload label {
            padding: 8px 12px !important;
            background: #2196F3;
            color: white;
            border-radius: 12px !important;
            cursor: pointer;
            white-space: nowrap !important;
            min-width: max-content !important;
            display: inline-block !important;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            margin: 10px 0;
            border: 2px solid #ccc;
            border-radius: 10px;
            outline: 1px solid #4CAF50;
            outline-offset: 1px;
        }

        /* Math solution styles */
        .math-solution {
            background: #f8f9fa;
            border-radius: 15px !important;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease-out;
        }

        .solution-header {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }

        .solution-steps {
            list-style-type: none;
            padding: 0;
        }

        .solution-step {
            padding: 5px 0;
            margin: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .solution-result {
            background: #e3f2fd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Animation styles */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Typing indicator styles */
        .typing-animation::after {
            content: '▋';
            animation: blink 0.7s infinite;
            margin-left: 2px;
            font-weight: bold;
        }

        .typing-indicator {
            display: inline-block;
            margin-left: 4px;
        }

        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 20px;
            background: #000;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        /* Thinking animation styles */
        .thinking-container {
            padding: 10px 15px;
            background: #e3f2fd;
            border-radius: 15px !important;
            margin: 10px 0;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .thinking-dots {
            display: inline-block;
        }

        .thinking-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #2196F3;
            margin: 0 2px;
        }

        .thinking-dots span:nth-child(1) {
            animation: bounce 1.4s infinite;
        }

        .thinking-dots span:nth-child(2) {
            animation: bounce 1.4s infinite 0.2s;
        }

        .thinking-dots span:nth-child(3) {
            animation: bounce 1.4s infinite 0.4s;
        }

        /* Install button styles */
        .install-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            display: none;
        }

        .install-button:hover {
            background: #1976D2;
        }

        /* Footer styles */
        .collapsible-footer {
            position: fixed;
            bottom: 0;
            left: 250px !important;
            width: calc(100% - 250px) !important;
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 15px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 9998;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .footer-toggle {
            position: fixed;
            top: 5px !important;
            left: 275px !important;
            width: 44px;
            height: 44px;
            line-height: 44px;  /* Match height for vertical centering */
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-size: 20px;
            transform: translateZ(0);  /* Force GPU acceleration */
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease;
        }

        .footer-toggle:hover {
            background: #1976D2;
        }

        .footer-toggle::before,
        .footer-toggle::after {
            display: none;
        }

        @media (max-width: 768px) {

            /* Add all existing mobile styles here */
            .conversation-toggle {
                display: block;
            }

            .conversation-list {
                transform: translateX(-100%);
            }

            .conversation-list.active {
                transform: translateX(0);
            }

            .chat-container {
                margin: 0 !important;
                padding: 0 !important;
            }

            .chat-messages {
                padding: 5px 10px;
            }

            .message {
                max-width: 92% !important;
                /* Slightly narrower on mobile */
            }

            #chatHeader {
                padding: 3px 10px !important;
            }

            .page-title {
                font-size: 1.2em !important;
            }

            .sub-title {
                font-size: 0.8em !important;
            }

            .chat-messages {
                padding: 8px 10px;
                /* Smaller padding on mobile */
                padding-bottom: calc(65px + env(safe-area-inset-bottom)) !important;
                margin-bottom: env(safe-area-inset-bottom) !important;
            }

            #chatHeader {
                padding: 5px !important;
                /* Reduced header padding */
                margin-bottom: 5px !important;
            }

            .page-title {
                font-size: 1.5em !important;
                /* Smaller title on mobile */
                margin-bottom: 5px !important;
            }

            .sub-title {
                font-size: 1em !important;
                /* Smaller subtitle on mobile */
            }

            .input-container {
                padding: 8px !important;
                padding-bottom: calc(8px + env(safe-area-inset-bottom)) !important;
            }

            .message {
                margin: 4px 0 !important;
                /* Reduced message spacing */
            }

            /* Ensure scrollbar is accessible */
            .chat-messages::-webkit-scrollbar {
                width: 6px !important;
                height: 6px !important;
                opacity: 0.5;
            }

            .chat-messages::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 3px;
            }

            .chat-messages::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
            }

            .footer-toggle {
                left: 9px !important;
                top: 52.5px !important;
                height: 38.5px !important;
                width: 38.5px !important;
            }

            .collapsible-footer {
                position: fixed !important;
                margin-left: 0 !important;
                width: 100% auto !important;
                border-right: 1px solid rgba(0, 0, 0, 0.1) !important;
                border-top-left-radius: 0 !important;
                left: 0 !important;
            }

            button,
            .image-upload label {
                padding: 8px 10px !important;
                /* Slightly reduced padding on mobile */
                font-size: 14px !important;
                /* Slightly smaller font on mobile */
            }
        }

        /* Overlay styles */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: auto !important;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        /* Utility classes */
        .scroll-lock {
            overflow: hidden !important;
            position: fixed;
            width: 100%;
        }

        /* Ensure content doesn't get hidden behind input */
        .message:last-child {
            margin-bottom: 10px !important;
        }

        /* Continued Styles Further Down */

        .footer-toggle-container {
            position: fixed;
            top: 5px;
            left: 330px;
            padding: 8px 12px;
            background: #2196F3;
            color: white;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            z-index: 9998;  /* Lower than the button */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            visibility: hidden;  /* Add visibility property */
            pointer-events: none;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .footer-toggle-container.visible {
            opacity: 1;
            visibility: visible;  /* Show when visible class is added */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="js/tf_model.js"></script>
    <script>
        // Add a script to handle the MathTFModel class
        class MathTFModel {
            constructor() {
                this.model = null;
            }

            async initModel() {
                // Load the model
                this.model = await tf.loadLayersModel('model/model.json');
                console.log('Model loaded');
            }

            async predict(input) {
                // Preprocess input
                const tensor = tf.tensor2d([input]);

                // Make prediction
                const prediction = this.model.predict(tensor);

                // Postprocess prediction
                const result = prediction.dataSync();
                return result;
            }
        }
    </script>

    <script>
        // Move these variables outside any function to make them globally accessible
        let mathModel = null;
        let conversations = {};
        let currentConversationId = null;
        let modelInitialized = false;

        // Update initialization to handle both model and conversations
        async function init() {
            try {
                // Load conversations first
                loadConversations();

                // Initialize model
                mathModel = new MathTFModel();
                await mathModel.initModel();
                modelInitialized = true;

                // Setup event listeners
                setupEventListeners();

                // Load active conversation or create new one
                const activeId = localStorage.getItem('activeConversationId');
                if (activeId && conversations[activeId]) {
                    await loadConversation(activeId);
                } else {
                    await newConversation();
                }

                console.log('Initialization complete');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        function setupEventListeners() {
            const userInput = document.getElementById('userInput');
            if (userInput) {
                // Add keypress event listener for Enter key
                userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevent default form submission
                        sendMessage();
                    }
                });

                // Add focus/blur events for input styling
                userInput.addEventListener('focus', () => {
                    userInput.style.border = '2px solid #4CAF50';
                });

                userInput.addEventListener('blur', () => {
                    userInput.style.border = '1px solid #ccc';
                });
            }
        }

        // Update the initialization call
        document.addEventListener('DOMContentLoaded', init);

        async function formatMessage(text) {
            // Convert markdown-style formatting to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold text
                .replace(/`(.*?)`/g, '<code>$1</code>')            // Code/examples
                .replace(/\n/g, '<br>')                            // Line breaks
                .replace(/• /g, '&bull; ');                        // Bullets
        }

        async function typeMessage(text, messageElement) {
            const formattedText = await formatMessage(text);
            let i = 0;
            messageElement.innerHTML = '';

            const temp = document.createElement('div');
            temp.innerHTML = formattedText;
            const plainText = temp.textContent;

            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            messageElement.appendChild(cursor);

            const chatMessages = document.getElementById('chatMessages');
            chatMessages.classList.add('typing');

            // Calculate typing speed based on message length
            const baseSpeed = 20;
            const speed = Math.max(5, baseSpeed - Math.floor(plainText.length / 100));

            return new Promise(resolve => {
                function type() {
                    if (i < plainText.length) {
                        messageElement.innerHTML = formattedText.substring(0, i + 1);
                        messageElement.appendChild(cursor);
                        i++;
                        const randomDelay = Math.random() * 10;
                        setTimeout(type, speed + randomDelay);
                    } else {
                        messageElement.innerHTML = formattedText;
                        chatMessages.classList.remove('typing');
                        resolve();
                    }
                }
                type();
            });
        }

        // Add some CSS for formatted messages
        const style = document.createElement('style');
        style.textContent = `
            .ai-message strong {
                font-weight: bold;
                color: #1976D2;
            }
            .ai-message code {
                background: #f5f5f5;
                padding: 2px 4px;
                border-radius: 3px;
                font-family: monospace;
                color: #e91e63;
            }
        `;
        document.head.appendChild(style);

        async function displayStructuredMessage(data, isUser, save = true) {
            const messages = document.getElementById('chatMessages');
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user-message' : 'ai-message'}`;

            if (!isUser) {
                document.body.classList.add('scroll-lock');
                messages.style.overflow = 'hidden';
            }

            if (!isUser && data.format === 'json') {
                const solution = document.createElement('div');
                solution.className = 'math-solution';
                solution.innerHTML = generateMathSolutionHTML(data);
                message.appendChild(solution);
                messages.appendChild(message);

                // Force scroll during solution display
                scrollToBottom(true);

                // Animate confidence after scroll
                const confidenceElement = solution.querySelector('.confidence-counter');
                if (confidenceElement) {
                    await animateConfidence(confidenceElement, data.solution.confidence);
                }
            } else {
                message.style.visibility = 'visible';
                message.style.opacity = '1';
                await typeMessage(typeof data === 'string' ? data : JSON.stringify(data), message);
                messages.appendChild(message);
            }

            // Release scroll lock after typing
            document.body.classList.remove('scroll-lock');
            messages.style.overflow = 'auto';
            scrollToBottom();
        }

        function animateConfidence(element, targetConfidence) {
            let current = 0;
            const duration = 2000;
            const start = performance.now();

            element.classList.add('confidence-loading');
            return new Promise(resolve => {
                function updateNumber(timestamp) {
                    const elapsed = timestamp - start;
                    const progress = Math.min(elapsed / duration, 1);
                    const easeOut = t => 1 - Math.pow(1 - t, 3);

                    current = Math.min(targetConfidence * easeOut(progress), targetConfidence);
                    element.textContent = `${current.toFixed(1)}%`;

                    if (progress < 1) {
                        requestAnimationFrame(updateNumber);
                    } else {
                        element.classList.remove('confidence-loading');
                        resolve();
                    }
                }
                requestAnimationFrame(updateNumber);
            });
        }

        async function addMessage(text, isUser, save = true) {
            const messages = document.getElementById('chatMessages');
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            messages.appendChild(message);

            if (!isUser) {
                await typeMessage(text, message);
            } else {
                message.textContent = text;
            }

            messages.scrollTop = messages.scrollHeight;

            // Save message to current conversation only
            if (save && currentConversationId && conversations[currentConversationId]) {
                if (!conversations[currentConversationId].messages) {
                    conversations[currentConversationId].messages = [];
                }

                const messageObj = {
                    text,
                    isUser,
                    timestamp: new Date().toISOString(),
                    type: 'text'
                };

                conversations[currentConversationId].messages.push(messageObj);

                // Update title only on first user message
                if (isUser && conversations[currentConversationId].messages.filter(m => m.isUser).length === 1) {
                    conversations[currentConversationId].title = text.substring(0, 30) +
                        (text.length > 30 ? '...' : '');
                }

                saveConversations();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addMessage(message, true);
            input.value = '';
            scrollToBottom();  // Scroll after user message

            // Lock body scroll on mobile
            if (window.innerWidth <= 768) {
                document.body.classList.add('scroll-lock');
            }

            // Add thinking indicator
            const messages = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message ai-message';
            thinkingDiv.innerHTML = `
                <div class="thinking-container">
                    <span style="color: #1976D2; font-weight: 500;">AI is thinking</span>
                    <div class="thinking-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messages.appendChild(thinkingDiv);
            scrollToBottom(false);  // Instant scroll for thinking indicator

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                // Remove thinking indicator
                messages.removeChild(thinkingDiv);

                const result = await response.text();
                try {
                    const jsonResult = JSON.parse(result);
                    await displayStructuredMessage(jsonResult, false, true);
                    if (currentConversationId) {
                        conversations[currentConversationId].messages.push({
                            text: JSON.stringify(jsonResult),
                            isUser: false,
                            timestamp: new Date().toISOString(),
                            type: 'math_solution'
                        });
                        saveConversations();
                    }
                } catch {
                    await addMessage(result, false, true);
                }

                // Unlock scroll and scroll to bottom
                document.body.classList.remove('scroll-lock');
                scrollToBottom();

            } catch (error) {
                messages.removeChild(thinkingDiv);
                document.body.classList.remove('scroll-lock');
                addMessage("I couldn't process that. Please try again.", false);
                scrollToBottom();
            }
        }

        function generateConversationId() {
            return 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function loadConversations() {
            const saved = localStorage.getItem('mathAIConversations');
            conversations = saved ? JSON.parse(saved) : {};
            updateConversationList();
        }

        function saveConversations() {
            if (currentConversationId && conversations[currentConversationId]) {
                // Save to localStorage
                localStorage.setItem('mathAIConversations', JSON.stringify(conversations));
                // Update the list display
                updateConversationList();
                console.log('Saved conversations:', conversations);
            }
        }

        function updateConversationList() {
            const list = document.getElementById('conversationList');
            const existingButton = list.querySelector('button');
            list.innerHTML = '';
            list.appendChild(existingButton);

            Object.entries(conversations).forEach(([id, conv]) => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.textContent = conv.title;
                item.onclick = () => loadConversation(id);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteConversation(id);
                };

                item.appendChild(deleteBtn);
                list.appendChild(item);
            });
        }

        async function initializeOrLoadConversation() {
            const saved = localStorage.getItem('mathAIConversations');
            conversations = saved ? JSON.parse(saved) : {};

            currentConversationId = localStorage.getItem('activeConversationId');

            if (!currentConversationId || !conversations[currentConversationId]) {
                currentConversationId = generateConversationId();
                conversations[currentConversationId] = {
                    id: currentConversationId,
                    title: 'Math Chat',
                    messages: [],
                    created: new Date().toISOString()
                };
                localStorage.setItem('activeConversationId', currentConversationId);

                // Add regular text greeting instead of math solution format
                await addGreeting();
            } else {
                // Load existing conversation
                loadConversation(currentConversationId);
            }

            updateConversationList();
        }

        function newConversation() {
            currentConversationId = generateConversationId();
            conversations[currentConversationId] = {
                id: currentConversationId,
                title: 'Math Chat',
                messages: [],
                created: new Date().toISOString()
            };
            localStorage.setItem('activeConversationId', currentConversationId);
            document.getElementById('chatMessages').innerHTML = '';
            addGreeting();
            saveConversations();
        }

        async function loadConversation(id) {
            // Save current conversation first
            if (currentConversationId) {
                saveConversations();
            }

            currentConversationId = id;
            localStorage.setItem('activeConversationId', id);

            const messages = document.getElementById('chatMessages');
            messages.innerHTML = '';

            if (!conversations[id]?.messages?.length) return;

            // Always instant load for better UX
            conversations[id].messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.isUser ? 'user-message' : 'ai-message'}`;

                if (msg.type === 'math_solution') {
                    // Create math solution display without animation
                    const jsonData = JSON.parse(msg.text);
                    const solution = document.createElement('div');
                    solution.className = 'math-solution';
                    solution.innerHTML = generateMathSolutionHTML(jsonData);
                    messageDiv.appendChild(solution);

                    // Set confidence value directly without animation
                    const confidenceElement = solution.querySelector('.confidence-counter');
                    if (confidenceElement) {
                        confidenceElement.textContent = `${jsonData.solution.confidence.toFixed(1)}%`;
                    }
                } else {
                    // Regular message without typing animation
                    messageDiv.innerHTML = msg.text;
                }

                messages.appendChild(messageDiv);
            });

            // Scroll to bottom after loading
            messages.scrollTop = messages.scrollHeight;
        }

        function generateMathSolutionHTML(data) {
            const answer = data.solution.display
                ? `${data.solution.answer} (${data.solution.display})`
                : data.solution.answer;

            return `
                <div class="solution-header">${data.problem.type || 'Math'} Problem: ${data.problem.input}</div>
                ${data.steps && data.steps.length > 0 ? `
                    <ul class="solution-steps">
                        ${data.steps.map(step => `<li class="solution-step">${step}</li>`).join('')}
                    </ul>
                ` : ''}
                <div class="solution-result">
                    Answer: ${answer}
                    <span class="confidence-indicator">
                        Confidence: <span class="confidence-counter">${data.solution.confidence.toFixed(1)}%</span>
                    </span>
                </div>
            `;
        }

        function deleteConversation(id) {
            delete conversations[id];
            saveConversations();
            if (id === currentConversationId) {
                newConversation();
            }
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Create preview
            const reader = new FileReader();
            reader.onload = async (e) => {
                const preview = new Image();
                preview.src = e.target.result;
                preview.className = 'preview-image';

                // Add preview above input
                const inputContainer = document.querySelector('.input-container');
                inputContainer.insertBefore(preview, inputContainer.firstChild);

                // Process image with OCR
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await fetch('/processImage', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.text();
                    document.getElementById('userInput').value = result;
                } catch (error) {
                    console.error('Error processing image:', error);
                }
            };
            reader.readAsDataURL(file);
        }

        async function addGreeting() {
            await addMessage("Hi! I'm ready to help with math. Try something like '2 + 2' or '2x + 3 = 7'", false, true);
        }

        // Add scroll lock during AI response
        function lockScroll(lock = true) {
            const messages = document.getElementById('chatMessages');
            if (lock) {
                messages.style.overflowY = 'hidden';
            } else {
                messages.style.overflowY = 'auto';
            }
        }

        function toggleConversationList() {
            const list = document.querySelector('.conversation-list');
            const overlay = document.querySelector('.overlay');
            list.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeConversationList() {
            const list = document.querySelector('.conversation-list');
            const overlay = document.querySelector('.overlay');
            list.classList.remove('active');
            overlay.classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Add overlay div
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.onclick = closeConversationList;
            document.body.appendChild(overlay);

            // Add menu toggle button
            const toggle = document.createElement('button');
            toggle.className = 'conversation-toggle';
            toggle.innerHTML = '☰';
            toggle.onclick = toggleConversationList;
            document.body.appendChild(toggle);

            // Close menu when selecting a conversation on mobile
            const conversationList = document.querySelector('.conversation-list');
            conversationList.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    closeConversationList();
                }
            });

            // Add touch event listeners for better mobile scrolling
            const messages = document.getElementById('chatMessages');
            let touchStartY;

            messages.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            messages.addEventListener('touchmove', (e) => {
                const touchY = e.touches[0].clientY;
                const isAtBottom = messages.scrollHeight - messages.scrollTop === messages.clientHeight;
                const isAtTop = messages.scrollTop === 0;

                // Prevent overscroll only at boundaries
                if ((isAtBottom && touchY < touchStartY) || (isAtTop && touchY > touchStartY)) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        // Add these new scroll management functions
        function scrollToBottom(smooth = true) {
            const messages = document.getElementById('chatMessages');
            const lastMessage = messages.lastElementChild;

            if (lastMessage) {
                lastMessage.scrollIntoView({
                    behavior: smooth ? 'smooth' : 'auto',
                    block: 'end'
                });
            }
        }

        function scrollToBottom(force = false) {
            const messages = document.getElementById('chatMessages');
            const lastMessage = messages.lastElementChild;

            if (lastMessage) {
                const containerHeight = messages.clientHeight;
                const lastMessageBottom = lastMessage.offsetTop + lastMessage.offsetHeight;
                const scrollDistance = lastMessageBottom - containerHeight;

                if (force) {
                    messages.scrollTop = scrollDistance;
                } else {
                    messages.scrollTo({
                        top: scrollDistance,
                        behavior: 'smooth'
                    });
                }
            }
        }

        // Add resize observer to handle keyboard
        document.addEventListener('DOMContentLoaded', () => {
            // Add overlay div
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.onclick = closeConversationList;
            document.body.appendChild(overlay);

            // Add menu toggle button
            const toggle = document.createElement('button');
            toggle.className = 'conversation-toggle';
            toggle.innerHTML = '☰';
            toggle.onclick = toggleConversationList;
            document.body.appendChild(toggle);

            // Close menu when selecting a conversation on mobile
            const conversationList = document.querySelector('.conversation-list');
            conversationList.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    closeConversationList();
                }
            });

            // Add touch event listeners for better mobile scrolling
            const messages = document.getElementById('chatMessages');
            let touchStartY;

            messages.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            messages.addEventListener('touchmove', (e) => {
                const touchY = e.touches[0].clientY;
                const isAtBottom = messages.scrollHeight - messages.scrollTop === messages.clientHeight;
                const isAtTop = messages.scrollTop === 0;

                // Prevent overscroll only at boundaries
                if ((isAtBottom && touchY < touchStartY) || (isAtTop && touchY > touchStartY)) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Add resize observer
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    if (entry.target === document.documentElement) {
                        // Check if height changed due to keyboard
                        if (window.innerHeight < window.visualViewport.height) {
                            document.body.style.height = window.visualViewport.height + 'px';
                            scrollToBottom(true);
                        }
                    }
                }
            });

            resizeObserver.observe(document.documentElement);

            // Handle viewport changes for mobile keyboards
            if ('visualViewport' in window) {
                window.visualViewport.addEventListener('resize', () => {
                    if (window.visualViewport.height < window.innerHeight) {
                        // Keyboard is open
                        document.body.style.height = window.visualViewport.height + 'px';
                        scrollToBottom(true);
                    }
                });
            }
        });

        // Add footer toggle functionality
        document.addEventListener('DOMContentLoaded', () => {
            const footer = document.createElement('div');
            footer.className = 'collapsible-footer';
            footer.innerHTML = `
                <p class="footer-text">Powered by <a href="about:blank">HtWebz Assistant</a> - & Created by Maximus Farvour</p>
                <div style="margin-top: 10px;">
                    <!-- Add any additional footer content here -->
                </div>
            `;

            const toggle = document.createElement('button');
            toggle.className = 'footer-toggle';
            toggle.id = 'footer-toggle';
            toggle.innerHTML = '↑';
            toggle.addEventListener('click', () => {
                footer.classList.toggle('active');
                toggle.innerHTML = footer.classList.contains('active') ? '↓' : '↑';
            });

            document.body.appendChild(footer);
            document.body.appendChild(toggle);
        });

        const footerToggleContainer = document.getElementById('footer-toggle-container');
        const footerToggleBtn = document.getElementById('footer-toggle');
        let tooltipTimeout;

        // Use mouseenter/mouseleave for more reliable hover detection
        footerToggleBtn.addEventListener('mouseenter', () => {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
                footerToggleContainer.classList.add('visible');
            }, 500);
        });

        footerToggleBtn.addEventListener('mouseleave', () => {
            clearTimeout(tooltipTimeout);
            footerToggleContainer.classList.remove('visible');
        });
    </script>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        // Add install prompt
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.style.display = 'none';
        installButton.className = 'install-button';
        installButton.textContent = 'Install App';

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';

            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                }
            });
        });

        // Add to chatHeader section
        document.getElementById('chatHeader').appendChild(installButton);
    </script>
    <style>
        .install-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            display: none;
        }

        .install-button:hover {
            background: #1976D2;
        }
    </style>
    <style>
        /* Updated Footer Styles */
        .collapsible-footer {
            position: fixed;
            bottom: 0;
            left: flex-start;
            width: calc(100% - 250px);
            background: rgba(255, 255, 255, 0.98);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            border-top-left-radius: 10px 12.5px;
            border-top-right-radius: 10px 12.5px;
            padding: 20px;
            transform: translateY(100%);
            transition: all 0.3s ease-out;
            z-index: 9997;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .collapsible-footer.active {
            transform: translateY(0);
        }

        .footer-text {
            text-align: center;
            font-size: 1.25em;
            color: #333;
            -webkit-text-stroke: 0.5px #004f9e;
            -webkit-text-fill-color: #2196F3;
            font-weight: bold;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .footer-toggle {
            position: fixed;
            bottom: 20px;
            left: 270px;
            margin-left: 1.5px;
            width: 44px;
            height: 44px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .footer-toggle:hover {
            transform: translateY(-2px);
            background: #1976D2;
        }

        @media (max-width: 768px) {
            .collapsible-footer {
                left: 0;
                width: 100%;
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }

            .footer-toggle {
                left: auto;
                right: 20px;
                bottom: 80px;
            }
        }

        .new-chat:hover {
            transition: all 0.3s ease;
            background: rgb(59, 137, 62);
        }

        .footer-toggle-container {
            position: fixed;
            top: 5px;
            left: 330px;
            padding: 8px 12px;
            background: #2196F3;
            color: white;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            white-space: nowrap;
        }

        .footer-toggle-container.visible {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="conversation-list" id="conversationList">
            <button onclick="newConversation()" class="new-chat" style="width: 100%; margin-bottom: 10px;">New Chat</button>
        </div>

        <div class="chat-container">
            <section id="chatHeader"
                style="display: flex; margin-left: 8.5%; justify-content: center; flex-direction: column;">
                <h1 class="page-title">AI Math Assistant</h1>
                <h3 class="sub-title">Module of HtWebz Assistant</h3>
            </section>

            <div class="chat-messages" id="chatMessages">
                <!--Chat messages will be appended and displayed here-->
            </div>
            <div class="input-container">
                <input type="text" id="userInput" placeholder="Type a math problem...">
                <button onclick="sendMessage()">Send</button>
                <div class="image-upload">
                    <label for="imageInput">📷 Upload</label>
                    <input type="file" id="imageInput" accept="image/*" onChange="handleImageUpload(event)">
                </div>
            </div>
        </div>
    </div>
    <div class="collapsible-footer">
        <p class="footer-text">
            Powered by <a href="javascript:void(0)">HtWebz Assistant</a> - Created by Maximus Farvour
        </p>
        <div style="margin-top: 10px; text-align: center; font-size: 0.9em; color: #666;">
            <p>© 2025 All rights reserved</p>
        </div>
    </div>
    <div class="footer-toggle-container" id="footer-toggle-container">
        <span class="footer-toggle-tag" id="footer-toggle-tag">Toggle Footer</span>
    </div>
    <button class="footer-toggle" id="footer-toggle" aria-label="Toggle footer">↑</button>

    <script>
        // Update hover event listeners to show the tooltip container
        footerToggleBtn.addEventListener('mouseover', () => {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
                footerToggleContainer.classList.add('visible');
            }, 500);
        });

        footerToggleBtn.addEventListener('mouseout', (e) => {
            clearTimeout(tooltipTimeout);
            // Check if we're not moving to the tooltip container
            if (!e.relatedTarget || !e.relatedTarget.closest('.footer-toggle-container')) {
                footerToggleContainer.classList.remove('visible');
            }
        });

        document.querySelector('.footer-toggle').addEventListener('click', () => {
            const footer = document.querySelector('.collapsible-footer');
            const toggle = document.querySelector('.footer-toggle');
            footer.classList.toggle('active');
            toggle.innerHTML = footer.classList.contains('active') ? '↓' : '↑';

            // Adjust chat messages padding when footer is shown (if necessary)
            const chatMessages = document.querySelector('.chat-messages');
            if (chatMessages) {
                chatMessages.style.paddingBottom = footer.classList.contains('active') ? '120px' : '70px';
            }
        });
    </script>
</body>
</html>
</html>