<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AI Math Solver</title>
    <style>
        /* Base styles */
        body {
            background-color: aquamarine;
            font-family: Arial, sans-serif;
        }

        .page-title {
            color: #1976D2;
            font-weight: bold;
            margin-bottom: 10px;
            -webkit-text-stroke: 1px #004f9e;
            -webkit-text-fill-color: #2196F3;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        /* Container styles */
        .app-container {
            position: relative;
            display: flex;
            max-width: 1200px;
            margin: 20px auto;
            gap: 20px;
            padding: 0 15px;
        }

        /* Conversation list styles */
        .conversation-list {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: white;
            border-right: 1px solid #ccc;
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 10px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .conversation-item:hover {
            background: #e0e0e0;
        }

        .conversation-item .delete-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            display: none;
        }

        .conversation-item:hover .delete-btn {
            display: block;
        }

        .conversation-toggle {
            display: none;
            position: fixed;
            left: 10px;
            top: 10px;
            z-index: 1001;
            padding: 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Chat container styles */
        .chat-container {
            flex: 1;
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .chat-messages {
            height: calc(100vh - 180px);
            max-height: calc(100vh - 180px);
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            scroll-behavior: smooth;
            position: relative;
            margin-bottom: 80px;
            padding-bottom: 120px !important;  /* More space for input */
        }

        .chat-messages.typing {
            scroll-snap-type: y mandatory;
        }

        .message:last-child {
            scroll-snap-align: end;
        }

        .message {
            margin: 5px 0;
            padding: 10px;
            border-radius: 15px !important;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .user-message {
            background: #e3f2fd;
            margin-left: 20px;
        }

        .ai-message {
            background: #f5f5f5;
            margin-right: 20px;
            position: relative;
            min-height: 20px;
        }

        .input-container {
            position: fixed !important;
            bottom: env(safe-area-inset-bottom) !important; /* Safari support */
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            padding: 12px !important;
            background: #ffffff !important;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 9999 !important;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.1);
            transform: translateZ(0) !important;
            -webkit-transform: translateZ(0) !important;
            margin: 0 !important;
        }

        input[type="text"] {
            flex: 1;
            padding: 8px;
            border-radius: 12px !important;
        }

        button {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 12px !important;
            cursor: pointer;
        }

        .image-upload {
            position: relative;
            cursor: pointer;
        }

        .image-upload input[type="file"] {
            display: none;
        }

        .image-upload label {
            padding: 8px 15px;
            background: #2196F3;
            color: white;
            border-radius: 12px !important;
            cursor: pointer;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            margin: 10px 0;
            border: 2px solid #ccc;
            border-radius: 10px;
            outline: 1px solid #4CAF50;
            outline-offset: 1px;
        }

        /* Add typing animation styles */
        .typing-animation {
            display: inline-block;
        }

        .typing-animation::after {
            content: 'â–‹';
            animation: blink 0.7s infinite;
            margin-left: 2px;
            font-weight: bold;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 16px;
            background: #000;
            margin-left: 2px;
            animation: blink 1s infinite;
        }

        /* Add math solution styles */
        .math-solution {
            background: #f8f9fa;
            border-radius: 15px !important;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease-out;
        }
        
        .solution-header {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }
        
        .solution-steps {
            list-style-type: none;
            padding: 0;
        }
        
        .solution-step {
            padding: 5px 0;
            margin: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .solution-result {
            background: #e3f2fd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .confidence-indicator {
            float: right;
            color: #4CAF50;
        }

        .confidence-counter {
            display: inline-block;
            font-family: 'Courier New', monospace;
            color: #4CAF50;
            font-weight: bold;
        }

        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            font-size: 1.1em;
        }
        .fraction sup {
            display: block;
            border-bottom: 1px solid;
            padding: 0 2px;
        }
        .fraction sub {
            display: block;
            padding: 0 2px;
        }
        #userInput {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            outline: none;
        }

        .typing-indicator {
            display: inline-block;
            margin-left: 4px;
        }

        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 20px;
            background: #000;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .footer-text {
            text-align: center;
            font-size: 1.25em;
            color: #333;
            -webkit-text-stroke: 1px #004f9e;
            -webkit-text-fill-color: #2196F3;
            font-weight: bold;
            margin-top: 20px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.15);
        }

        /* Add to existing styles */
        .thinking-container {
            padding: 10px 15px;
            background: #e3f2fd;
            border-radius: 15px !important;
            margin: 10px 0;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        .thinking-dots {
            display: inline-block;
        }
        
        .thinking-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #2196F3;
            margin: 0 2px;
        }
        
        .thinking-dots span:nth-child(1) { animation: bounce 1.4s infinite; }
        .thinking-dots span:nth-child(2) { animation: bounce 1.4s infinite 0.2s; }
        .thinking-dots span:nth-child(3) { animation: bounce 1.4s infinite 0.4s; }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .conversation-toggle {
                display: block;
            }

            .conversation-list {
                transform: translateX(-100%);
            }

            .conversation-list.active {
                transform: translateX(0);
            }

            .chat-container {
                padding: 10px;
                margin: 0;
                background: rgba(255, 255, 255, 0.85);
                border-radius: 0;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .chat-messages {
                height: calc(100vh - 180px);
                max-height: calc(100vh - 180px);
                margin: 60px 0 80px 0;  /* Increased bottom margin for input */
                padding-bottom: 20px;
                overflow-y: hidden;
                background: transparent;
                box-shadow: none;
                position: absolute;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 80px;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
                margin: 0;
                padding: 15px;
                padding-bottom: 140px !important;  /* Even more space on mobile */
            }

            #chatHeader {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                z-index: 100;
                padding: 10px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                height: 60px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                z-index: 100;
                border-bottom: 1px solid rgba(0,0,0,0.1);
                border-radius: 0 0 15px 15px;
            }

            .input-container {
                background: rgba(255, 255, 255, 0.98) !important;
                border-radius: 0 !important;
                bottom: 0 !important;
                padding: 12px !important;
                margin: 0 !important;
                width: 100% !important;
                transform: none !important;
                left: 0 !important;
            }

            .chat-messages {
                height: calc(100vh - 160px);
                padding-bottom: 100px !important;
                margin-bottom: 0 !important;
            }

            #userInput {
                height: 44px !important;
                font-size: 16px !important;
            }

            /* Ensure content doesn't get hidden behind input */
            .chat-container {
                margin-bottom: 60px !important;
            }

            /* Improve message visibility on mobile */
            .message {
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(4px);
                -webkit-backdrop-filter: blur(4px);
                margin: 8px 0;
            }

            .user-message {
                background: rgba(227, 242, 253, 0.9);
            }

            .ai-message {
                background: rgba(245, 245, 245, 0.9);
            }

            body {
                position: fixed;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            .chat-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                overflow: hidden;
            }

            /* Ensure buttons and inputs are easier to tap */
            button, .image-upload label {
                min-height: 44px;
                padding: 10px 20px;
            }

            input[type="text"] {
                min-height: 44px;
                font-size: 16px; /* Prevent zoom on iOS */
                height: 44px !important;  /* Taller input on mobile */
            }
        }

        /* Overlay for mobile when menu is open */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        /* Adjust chat message sizes for mobile */
        @media (max-width: 480px) {
            .message {
                font-size: 0.9em;
                padding: 8px;
            }

            .user-message {
                margin-left: 10px;
            }

            .ai-message {
                margin-right: 10px;
            }
        }

        /* Add scroll lock class */
        .scroll-lock {
            overflow: hidden !important;
            position: fixed;
            width: 100%;
        }

        /* Add container shadow for desktop */
        @media (min-width: 769px) {
            .app-container {
                padding: 20px;
                margin: 20px auto;
            }

            .chat-container {
                margin-left: 270px;  /* Space for conversation list */
                max-width: 900px;
            }
        }

        /* Update input container base styles */
        .input-container {
            position: fixed !important;
            bottom: 20px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: min(calc(100% - 30px), 800px) !important;
            padding: 15px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px !important;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            gap: 10px;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Update chat messages spacing */
        .chat-messages {
            /* ...existing chat-messages styles... */
            padding-bottom: 100px !important;
            margin-bottom: 0;
        }

        /* Improve input styling */
        #userInput {
            height: 44px !important;
            min-height: 44px;
            font-size: 16px;
            padding: 10px 15px;
            border-radius: 15px !important;
            border: 1px solid rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.9);
        }

        button, .image-upload label {
            height: 44px !important;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 15px;
            font-size: 15px;
            border-radius: 15px !important;
        }

        /* Mobile specific updates */
        @media (max-width: 768px) {
            .input-container {
                margin-bottom: 130px !important;
                width: calc(100% - 20px) !important;
                padding: 12px;
                border-radius: 16px !important;
            }

            .chat-messages {
                /* ...existing mobile chat-messages styles... */
                padding-bottom: 500px !important;
            }

            #userInput {
                font-size: 16px !important;
            }

            .image-upload label {
                padding: 0 12px;
            }

            /* Fix footer overlap */
            footer {
                margin-bottom: 80px;
            }
        }

        /* Add hover effects */
        #userInput:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        button:hover, .image-upload label:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Fix input container */
        .input-container {
            position: fixed !important;
            margin-bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            padding: 12px !important;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 9999 !important; /* Ensure it's always on top */
            display: flex;
            gap: 10px;
            align-items: center;
            transform: none !important;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        /* Fix chat messages spacing */
        .chat-messages {
            padding-bottom: 90px !important;
        }

        .message:last-child {
            margin-bottom: 70px !important;
        }

        /* Mobile specific fixes */
        @media (max-width: 768px) {
            .chat-messages {
                height: calc(100vh - 160px);
                margin-bottom: 0;
                padding-bottom: 90px !important;
            }

            .message:last-child {
                margin-bottom: 80px !important;
            }

            .input-container {
                position: fixed !important;
                margin-bottom: 200px !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                transform: none !important;
                border-radius: 0 !important;
                padding-right: 20px;
                margin-inline: 0 !important;
            }

            /* Ensure content doesn't get hidden */
            .chat-container {
                padding-bottom: 80px !important;
            }
        }

        /* Update input container positioning */
        .input-container {
            position: fixed !important;
            bottom: env(safe-area-inset-bottom) !important; /* Safari support */
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            padding: 12px !important;
            background: #ffffff !important;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 9999 !important;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.1);
            transform: translateZ(0) !important;
            -webkit-transform: translateZ(0) !important;
            margin: 0 !important;
        }

        /* Fix chat messages spacing */
        .chat-messages {
            /* ...existing styles... */
            padding-bottom: 80px !important;
            margin-bottom: env(safe-area-inset-bottom) !important;
        }

        /* Mobile Safari fixes */
        @supports (-webkit-touch-callout: none) {
            .input-container {
                padding-bottom: calc(12px + env(safe-area-inset-bottom)) !important;
            }
            
            .chat-messages {
                padding-bottom: calc(80px + env(safe-area-inset-bottom)) !important;
            }

            /* Ensure content stays in viewport */
            body {
                height: -webkit-fill-available;
            }

            .chat-container {
                min-height: -webkit-fill-available;
            }
        }

        @media (max-width: 768px) {
            .input-container {
                bottom: 0 !important;
                position: fixed !important;
                width: 100% !important;
                background: white !important;
                border-radius: 0 !important;
            }

            #userInput {
                margin: 0 !important;
                padding: 12px !important;
            }

            /* Hide footer on mobile */
            footer {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="js/tf_model.js"></script>
    <script>
        // Add a script to handle the MathTFModel class
        class MathTFModel {
            constructor() {
                this.model = null;
            }

            async initModel() {
                // Load the model
                this.model = await tf.loadLayersModel('model/model.json');
                console.log('Model loaded');
            }

            async predict(input) {
                // Preprocess input
                const tensor = tf.tensor2d([input]);

                // Make prediction
                const prediction = this.model.predict(tensor);

                // Postprocess prediction
                const result = prediction.dataSync();
                return result;
            }
        }
    </script>
    
    <script>
        // Move these variables outside any function to make them globally accessible
        let mathModel = null;
        let conversations = {};
        let currentConversationId = null;
        let modelInitialized = false;

        // Update initialization to handle both model and conversations
        async function init() {
            try {
                // Load conversations first
                loadConversations();
                
                // Initialize model
                mathModel = new MathTFModel();
                await mathModel.initModel();
                modelInitialized = true;

                // Setup event listeners
                setupEventListeners();

                // Load active conversation or create new one
                const activeId = localStorage.getItem('activeConversationId');
                if (activeId && conversations[activeId]) {
                    await loadConversation(activeId);
                } else {
                    await newConversation();
                }

                console.log('Initialization complete');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        function setupEventListeners() {
            const userInput = document.getElementById('userInput');
            if (userInput) {
                // Add keypress event listener for Enter key
                userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevent default form submission
                        sendMessage();
                    }
                });

                // Add focus/blur events for input styling
                userInput.addEventListener('focus', () => {
                    userInput.style.border = '2px solid #4CAF50';
                });

                userInput.addEventListener('blur', () => {
                    userInput.style.border = '1px solid #ccc';
                });
            }
        }

        // Update the initialization call
        document.addEventListener('DOMContentLoaded', init);

        async function formatMessage(text) {
            // Convert markdown-style formatting to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold text
                .replace(/`(.*?)`/g, '<code>$1</code>')            // Code/examples
                .replace(/\n/g, '<br>')                            // Line breaks
                .replace(/â€¢ /g, '&bull; ');                        // Bullets
        }

        async function typeMessage(text, messageElement) {
            const formattedText = await formatMessage(text);
            let i = 0;
            messageElement.innerHTML = '';
            
            const temp = document.createElement('div');
            temp.innerHTML = formattedText;
            const plainText = temp.textContent;
            
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            messageElement.appendChild(cursor);

            const chatMessages = document.getElementById('chatMessages');
            chatMessages.classList.add('typing');
            
            // Calculate typing speed based on message length
            const baseSpeed = 20;
            const speed = Math.max(5, baseSpeed - Math.floor(plainText.length / 100));
            
            return new Promise(resolve => {
                function type() {
                    if (i < plainText.length) {
                        messageElement.innerHTML = formattedText.substring(0, i + 1);
                        messageElement.appendChild(cursor);
                        i++;
                        const randomDelay = Math.random() * 10;
                        setTimeout(type, speed + randomDelay);
                    } else {
                        messageElement.innerHTML = formattedText;
                        chatMessages.classList.remove('typing');
                        resolve();
                    }
                }
                type();
            });
        }

        // Add some CSS for formatted messages
        const style = document.createElement('style');
        style.textContent = `
            .ai-message strong {
                font-weight: bold;
                color: #1976D2;
            }
            .ai-message code {
                background: #f5f5f5;
                padding: 2px 4px;
                border-radius: 3px;
                font-family: monospace;
                color: #e91e63;
            }
        `;
        document.head.appendChild(style);

        async function displayStructuredMessage(data, isUser, save = true) {
            const messages = document.getElementById('chatMessages');
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user-message' : 'ai-message'}`;

            if (!isUser && data.format === 'json') {
                // Math solution display
                const solution = document.createElement('div');
                solution.className = 'math-solution';
                solution.innerHTML = generateMathSolutionHTML(data);
                message.appendChild(solution);
                messages.appendChild(message);

                // Smooth scroll with slight delay for animation
                setTimeout(() => {
                    messages.scrollTo({
                        top: messages.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);

                // Animate confidence after scroll
                const confidenceElement = solution.querySelector('.confidence-counter');
                await animateConfidence(confidenceElement, data.solution.confidence);
            } else {
                await typeMessage(typeof data === 'string' ? data : JSON.stringify(data), message);
                messages.appendChild(message);
            }

            messages.scrollTop = messages.scrollHeight;
        }

        function animateConfidence(element, targetConfidence) {
            let current = 0;
            const duration = 2000;
            const start = performance.now();

            element.classList.add('confidence-loading');
            return new Promise(resolve => {
                function updateNumber(timestamp) {
                    const elapsed = timestamp - start;
                    const progress = Math.min(elapsed / duration, 1);
                    const easeOut = t => 1 - Math.pow(1 - t, 3);
                    
                    current = Math.min(targetConfidence * easeOut(progress), targetConfidence);
                    element.textContent = `${current.toFixed(1)}%`;
                    
                    if (progress < 1) {
                        requestAnimationFrame(updateNumber);
                    } else {
                        element.classList.remove('confidence-loading');
                        resolve();
                    }
                }
                requestAnimationFrame(updateNumber);
            });
        }

        async function addMessage(text, isUser, save = true) {
            const messages = document.getElementById('chatMessages');
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            messages.appendChild(message);

            if (!isUser) {
                await typeMessage(text, message);
            } else {
                message.textContent = text;
            }

            messages.scrollTop = messages.scrollHeight;

            // Save message to current conversation only
            if (save && currentConversationId && conversations[currentConversationId]) {
                if (!conversations[currentConversationId].messages) {
                    conversations[currentConversationId].messages = [];
                }
                
                const messageObj = {
                    text,
                    isUser,
                    timestamp: new Date().toISOString(),
                    type: 'text'
                };
                
                conversations[currentConversationId].messages.push(messageObj);
                
                // Update title only on first user message
                if (isUser && conversations[currentConversationId].messages.filter(m => m.isUser).length === 1) {
                    conversations[currentConversationId].title = text.substring(0, 30) + 
                        (text.length > 30 ? '...' : '');
                }
                
                saveConversations();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            scrollToBottom();  // Scroll after user message

            // Lock body scroll on mobile
            if (window.innerWidth <= 768) {
                document.body.classList.add('scroll-lock');
            }

            // Add thinking indicator
            const messages = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message ai-message';
            thinkingDiv.innerHTML = `
                <div class="thinking-container">
                    <span style="color: #1976D2; font-weight: 500;">AI is thinking</span>
                    <div class="thinking-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messages.appendChild(thinkingDiv);
            scrollToBottom(false);  // Instant scroll for thinking indicator

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                // Remove thinking indicator
                messages.removeChild(thinkingDiv);

                const result = await response.text();
                try {
                    const jsonResult = JSON.parse(result);
                    await displayStructuredMessage(jsonResult, false, true);
                    if (currentConversationId) {
                        conversations[currentConversationId].messages.push({
                            text: JSON.stringify(jsonResult),
                            isUser: false,
                            timestamp: new Date().toISOString(),
                            type: 'math_solution'
                        });
                        saveConversations();
                    }
                } catch {
                    await addMessage(result, false, true);
                }
                
                // Unlock scroll and scroll to bottom
                document.body.classList.remove('scroll-lock');
                scrollToBottom();
                
            } catch (error) {
                messages.removeChild(thinkingDiv);
                document.body.classList.remove('scroll-lock');
                addMessage("I couldn't process that. Please try again.", false);
                scrollToBottom();
            }
        }

        function generateConversationId() {
            return 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function loadConversations() {
            const saved = localStorage.getItem('mathAIConversations');
            conversations = saved ? JSON.parse(saved) : {};
            updateConversationList();
        }

        function saveConversations() {
            if (currentConversationId && conversations[currentConversationId]) {
                // Save to localStorage
                localStorage.setItem('mathAIConversations', JSON.stringify(conversations));
                // Update the list display
                updateConversationList();
                console.log('Saved conversations:', conversations);
            }
        }

        function updateConversationList() {
            const list = document.getElementById('conversationList');
            const existingButton = list.querySelector('button');
            list.innerHTML = '';
            list.appendChild(existingButton);
            
            Object.entries(conversations).forEach(([id, conv]) => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.textContent = conv.title;
                item.onclick = () => loadConversation(id);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteConversation(id);
                };

                item.appendChild(deleteBtn);
                list.appendChild(item);
            });
        }

        async function initializeOrLoadConversation() {
            const saved = localStorage.getItem('mathAIConversations');
            conversations = saved ? JSON.parse(saved) : {};
            
            currentConversationId = localStorage.getItem('activeConversationId');
            
            if (!currentConversationId || !conversations[currentConversationId]) {
                currentConversationId = generateConversationId();
                conversations[currentConversationId] = {
                    id: currentConversationId,
                    title: 'Math Chat',
                    messages: [],
                    created: new Date().toISOString()
                };
                localStorage.setItem('activeConversationId', currentConversationId);
                
                // Add regular text greeting instead of math solution format
                await addGreeting();
            } else {
                // Load existing conversation
                loadConversation(currentConversationId);
            }
            
            updateConversationList();
        }

        function newConversation() {
            currentConversationId = generateConversationId();
            conversations[currentConversationId] = {
                id: currentConversationId,
                title: 'Math Chat',
                messages: [],
                created: new Date().toISOString()
            };
            localStorage.setItem('activeConversationId', currentConversationId);
            document.getElementById('chatMessages').innerHTML = '';
            addGreeting();
            saveConversations();
        }

        async function loadConversation(id) {
            // Save current conversation first
            if (currentConversationId) {
                saveConversations();
            }
            
            currentConversationId = id;
            localStorage.setItem('activeConversationId', id);
            
            const messages = document.getElementById('chatMessages');
            messages.innerHTML = '';
            
            if (!conversations[id]?.messages?.length) return;

            // Always instant load for better UX
            conversations[id].messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.isUser ? 'user-message' : 'ai-message'}`;
                
                if (msg.type === 'math_solution') {
                    // Create math solution display without animation
                    const jsonData = JSON.parse(msg.text);
                    const solution = document.createElement('div');
                    solution.className = 'math-solution';
                    solution.innerHTML = generateMathSolutionHTML(jsonData);
                    messageDiv.appendChild(solution);
                    
                    // Set confidence value directly without animation
                    const confidenceElement = solution.querySelector('.confidence-counter');
                    if (confidenceElement) {
                        confidenceElement.textContent = `${jsonData.solution.confidence.toFixed(1)}%`;
                    }
                } else {
                    // Regular message without typing animation
                    messageDiv.innerHTML = msg.text;
                }
                
                messages.appendChild(messageDiv);
            });
            
            // Scroll to bottom after loading
            messages.scrollTop = messages.scrollHeight;
        }

        function generateMathSolutionHTML(data) {
            const answer = data.solution.display 
                ? `${data.solution.answer} (${data.solution.display})`
                : data.solution.answer;
            
            return `
                <div class="solution-header">${data.problem.type || 'Math'} Problem: ${data.problem.input}</div>
                ${data.steps && data.steps.length > 0 ? `
                    <ul class="solution-steps">
                        ${data.steps.map(step => `<li class="solution-step">${step}</li>`).join('')}
                    </ul>
                ` : ''}
                <div class="solution-result">
                    Answer: ${answer}
                    <span class="confidence-indicator">
                        Confidence: <span class="confidence-counter">${data.solution.confidence.toFixed(1)}%</span>
                    </span>
                </div>
            `;
        }

        function deleteConversation(id) {
            delete conversations[id];
            saveConversations();
            if (id === currentConversationId) {
                newConversation();
            }
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Create preview
            const reader = new FileReader();
            reader.onload = async (e) => {
                const preview = document.createElement('img');
                preview.src = e.target.result;
                preview.className = 'preview-image';
                
                // Add preview above input
                const inputContainer = document.querySelector('.input-container');
                inputContainer.insertBefore(preview, inputContainer.firstChild);

                // Process image with OCR
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await fetch('/processImage', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.text();
                    document.getElementById('userInput').value = result;
                } catch (error) {
                    console.error('Error processing image:', error);
                }
            };
            reader.readAsDataURL(file);
        }

        async function addGreeting() {
            await addMessage("Hi! I'm ready to help with math. Try something like '2 + 2' or '2x + 3 = 7'", false, true);
        }

        // Add scroll lock during AI response
        function lockScroll(lock = true) {
            const messages = document.getElementById('chatMessages');
            if (lock) {
                messages.style.overflowY = 'hidden';
            } else {
                messages.style.overflowY = 'auto';
            }
        }

        function toggleConversationList() {
            const list = document.querySelector('.conversation-list');
            const overlay = document.querySelector('.overlay');
            list.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeConversationList() {
            const list = document.querySelector('.conversation-list');
            const overlay = document.querySelector('.overlay');
            list.classList.remove('active');
            overlay.classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Add overlay div
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.onclick = closeConversationList;
            document.body.appendChild(overlay);

            // Add menu toggle button
            const toggle = document.createElement('button');
            toggle.className = 'conversation-toggle';
            toggle.innerHTML = 'â˜°';
            toggle.onclick = toggleConversationList;
            document.body.appendChild(toggle);

            // Close menu when selecting a conversation on mobile
            const conversationList = document.querySelector('.conversation-list');
            conversationList.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    closeConversationList();
                }
            });

            // Add touch event listeners for better mobile scrolling
            const messages = document.getElementById('chatMessages');
            let touchStartY;

            messages.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            messages.addEventListener('touchmove', (e) => {
                const touchY = e.touches[0].clientY;
                const isAtBottom = messages.scrollHeight - messages.scrollTop === messages.clientHeight;
                const isAtTop = messages.scrollTop === 0;
                
                // Prevent overscroll only at boundaries
                if ((isAtBottom && touchY < touchStartY) || (isAtTop && touchY > touchStartY)) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        // Add these new scroll management functions
        function scrollToBottom(smooth = true) {
            const messages = document.getElementById('chatMessages');
            const lastMessage = messages.lastElementChild;
            
            if (lastMessage) {
                lastMessage.scrollIntoView({
                    behavior: smooth ? 'smooth' : 'auto',
                    block: 'end'
                });
            }
        }
    </script>
</head>
<body>
    <div class="app-container">
        <div class="conversation-list" id="conversationList">
            <button onclick="newConversation()" style="width: 100%; margin-bottom: 10px;">New Chat</button>
        </div>
        
        <div class="chat-container">
            <section id="chatHeader" style="text-align: start; flex: 1.0 auto; display: flex; justify-content: flex-start center; align-items: center; flex-direction: column; gap: 4px; flex-flow: calc(--Chat 5px);">
                <h1 class="page-title">AI Math Assistant</h1>
                <h3 class="sub-title">Module of HtWebz Assistant</h3>
            </section>

            <div class="chat-messages" id="chatMessages">
                <!--Chat messages will be appended and displayed here-->
            </div>
            <div class="input-container">
                <input type="text" id="userInput" placeholder="Type a math problem...">
                <button onclick="sendMessage()">Send</button>
                <div class="image-upload">
                    <label for="imageInput">ðŸ“· Upload</label>
                    <input type="file" id="imageInput" accept="image/*" onChange="handleImageUpload(event)">
                </div>
            </div>
        </div>
    </div>
        <footer>
            <p class="footer-text">Powered by <a href="about:blank">HtWebz Assistant</a> - & Created by Maximus Farvour</p>
        </footer>
    </body>
</html>
